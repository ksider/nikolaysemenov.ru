!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).JcampConverter={})}(this,(function(e){"use strict";function t(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e)return e;if(ArrayBuffer.isView(e)||e instanceof ArrayBuffer){const{encoding:s=n(e)}=t;return new TextDecoder(s).decode(e)}throw new TypeError("blob must be a string, ArrayBuffer or ArrayBufferView")}function n(e){const t=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);if(t.length>=2){if(254===t[0]&&255===t[1])return"utf-16be";if(255===t[0]&&254===t[1])return"utf-16le"}return function(e){if(!e)return!1;for(var t=0,n=e.length;t<n;)if(e[t]<=127)t++;else{if(e[t]>=194&&e[t]<=223){if(e[t+1]>>6==2){t+=2;continue}return!1}if((224===e[t]&&e[t+1]>=160&&e[t+1]<=191||237===e[t]&&e[t+1]>=128&&e[t+1]<=159)&&e[t+2]>>6==2)t+=3;else if((e[t]>=225&&e[t]<=236||e[t]>=238&&e[t]<=239)&&e[t+1]>>6==2&&e[t+2]>>6==2)t+=3;else{if(!(240===e[t]&&e[t+1]>=144&&e[t+1]<=191||e[t]>=241&&e[t]<=243&&e[t+1]>>6==2||244===e[t]&&e[t+1]>=128&&e[t+1]<=143)||e[t+2]>>6!=2||e[t+3]>>6!=2)return!1;t+=4}}return!0}(e)?"utf-8":"latin1"}function s(e){if(4===e.length||5===e.length){let t=e.toLowerCase();if("true"===t)return!0;if("false"===t)return!1}let t=Number(e);return 0!==t||e.includes("0")?Number.isNaN(t)?e:t:e}const l=["TIC",".RIC","SCANNUMBER"];function r(e){let t=e.spectra,n=t.length,s={times:new Array(n),series:{ms:{dimension:2,data:new Array(n)}}},r=[];for(let e=0;e<l.length;e++){let i=a(l[e]);t[0][i]&&(r.push(i),s.series[i]={dimension:1,data:new Array(n)})}for(let e=0;e<n;e++){let n=t[e];s.times[e]=n.pageValue;for(let t=0;t<r.length;t++)s.series[r[t]].data[e]=Number(n[r[t]]);n.data&&(s.series.ms.data[e]=[n.data.x,n.data.y])}e.chromatogram=s}function i(e){return-1!==l.indexOf(e)}function a(e){return e.toLowerCase().replace(/[^a-z0-9]/g,"")}function u(e){let t=[];for(let n=0;n<e.length;n++)t.push(Number(e[n]));return t}function o(e,t){let n=e.yFactor,s=e.deltaX;e.isXYdata=!0;let l={x:[],y:[]};e.data=l;let r,i=e.firstX,a=e.firstY,u=!1,o=0;for(;o<t.length;o++)if(r=t.charCodeAt(o),13===r||10===r)u=!0;else if(u)break;let p=!0,f=!1,c=!1,h=0,m=!1,d=!1,g=0,b=0,y=!1,A=!1,x=!1,T=0;for(;o<=t.length;o++)if(r=o===t.length?13:t.charCodeAt(o),d)13!==r&&10!==r||(p=!0,d=!1);else if(r<=57&&r>=48)A=!0,T>0?g+=(r-48)/Math.pow(10,T++):(g*=10,g+=r-48);else if(44===r||46===r)A=!0,T++;else{if(A){if(p)p=!1,c&&(x=!0);else if(x)x=!1;else{f?(h=y?0-g:g,c=!0,f=!1):m||(b=y?0-g:g);let e=m?g-1:1;for(let t=0;t<e;t++)c?a+=h:a=b,l.x.push(i),l.y.push(a*n),i+=s}y=!1,g=0,T=0,A=!1,m=!1}if(r<74&&r>63)A=!0,c=!1,g=r-64;else if(r>96&&r<106)A=!0,c=!1,g=r-96,y=!0;else if(115===r)A=!0,m=!0,g=9;else if(r>82&&r<91)A=!0,m=!0,g=r-82;else if(r>73&&r<83)A=!0,f=!0,g=r-73;else if(r>105&&r<115)A=!0,f=!0,g=r-105,y=!0;else if(36===r&&36===t.charCodeAt(o+1))A=!0,d=!0;else if(37===r)A=!0,f=!0,g=0,y=!1;else if(45===r){let e=t.charCodeAt(o+1);(e>=48&&e<=57||44===e||46===e)&&(A=!0,p||(c=!1),y=!0)}else 13!==r&&10!==r||(p=!0,d=!1)}}const p=/\$\$.*/,f=/[,\t ]+/;function c(e,t,n){if(e.isPeaktable=!0,e.variables&&2!==Object.keys(e.variables)?function(e,t,n){let s={},l=Object.keys(e.variables),r=l.length;l.forEach((e=>s[e]=[])),e.data=s;let i=t.split(/,? *,?[;\r\n]+ */);for(let e=1;e<i.length;e++){let t=i[e].trim().replace(p,"").split(f);if(t.length%r==0)for(let e=0;e<t.length;e++)s[l[e%r]].push(Number(t[e]));else n.logs.push(`Format error: ${t}`)}}(e,t,n):function(e,t,n){let s={x:[],y:[]};e.data=s;let l=t.split(/,? *,?[;\r\n]+ */);for(let t=1;t<l.length;t++){let r=l[t].trim().replace(p,"").split(f);if(r.length%2==0)for(let t=0;t<r.length;t+=2)s.x.push(Number(r[t])*e.xFactor),s.y.push(Number(r[t+1])*e.yFactor);else n.logs.push(`Format error: ${r}`)}}(e,t,n),e.variables)for(let t in e.variables)e.variables[t].data=e.data[t]}function h(e,t){e.isXYAdata=!0;const n={};e.data=n;let s=t.split(/\r?\n/);const l=s[0].replace(/^.*?([A-Z]+).*$/,"$1").split("").map((e=>e.toLowerCase()));for(let e=1;e<s.length;e++){const t=s[e].replace(/^\((.*)\)$/,"$1").split(/ *, */);for(let e=0;e<l.length;e++){let s=t[e];switch(l[e]){case"x":case"y":case"w":s=Number.parseFloat(s);break;case"a":s=s.replace(/^<(.*)>$/,"$1");break;case"m":break;default:continue}n[l[e]]||(n[l[e]]=[]),n[l[e]].push(s)}}}const m=Object.prototype.toString;var d={exports:{}};!function(e){!function(){function t(e){for(var t=0,l=e.length-1,r=void 0,i=void 0,a=void 0,u=s(t,l);;){if(l<=t)return e[u];if(l==t+1)return e[t]>e[l]&&n(e,t,l),e[u];for(e[r=s(t,l)]>e[l]&&n(e,r,l),e[t]>e[l]&&n(e,t,l),e[r]>e[t]&&n(e,r,t),n(e,r,t+1),i=t+1,a=l;;){do{i++}while(e[t]>e[i]);do{a--}while(e[a]>e[t]);if(a<i)break;n(e,i,a)}n(e,t,a),a<=u&&(t=i),a>=u&&(l=a-1)}}var n=function(e,t,n){var s;return s=[e[n],e[t]],e[t]=s[0],e[n]=s[1],s},s=function(e,t){return~~((e+t)/2)};e.exports?e.exports=t:window.median=t}()}(d);var g=d.exports;function b(e){if(t=e,!m.call(t).endsWith("Array]"))throw new TypeError("input must be an array");var t;if(0===e.length)throw new TypeError("input must not be empty");return g(e.slice())}function y(e,t){let n=function(e){let t=e[0].data.y[0],n=t,s=e.length,l=e[0].data.x.length,r=new Array(s);for(let i=0;i<s;i++){r[i]=e[i].data.y;for(let e=0;e<l;e++){let s=r[i][e];s<t&&(t=s),s>n&&(n=s)}}const i=e[0].data.x[0],a=e[0].data.x[e[0].data.x.length-1],u=e[0].pageValue,o=e[s-1].pageValue;if(i>a)for(let e of r)e.reverse();u>o&&r.reverse();const p=[];for(let e=0;e<r.length;e++){const t=Float64Array.from(r[e]);for(let e=0;e<t.length;e++)t[e]<0&&(t[e]=-t[e]);p.push(b(t))}const f=b(p);return{z:r,minX:Math.min(i,a),maxX:Math.max(i,a),minY:Math.min(u,o),maxY:Math.max(u,o),minZ:t,maxZ:n,noise:f}}(e.spectra);t.noContour||(e.contourLines=function(e,t){let n,s,l,r,i,a,u,o,p,f,c,h,m,d=e.noise,g=e.z,b=g.length,y=g[0].length,A=e.minX,x=(e.maxX-A)/(y-1),T=e.minY,N=(e.maxY-T)/(b-1),X=e.minZ,v=e.maxZ,E=2*t.nbContourLevels,w=new Array(E);for(let e=0;e<E;e++){let E={};w[e]=E;let F=e%2,C=(v-t.noiseMultiplier*d)*Math.exp((e>>1)-t.nbContourLevels);m=0===F?C+t.noiseMultiplier*d:0-C-t.noiseMultiplier*d;let S=[];if(E.zValue=m,E.lines=S,!(m<=X||m>=v))for(let e=0;e<b-1;e++){let t=g[e],d=g[e+1];for(let g=0;g<y-1;g++)n=t[g],s=t[g+1],l=d[g],r=d[g+1],i=n>m,a=s>m,u=l>m,o=r>m,i!==a&&i!==u&&(p=g+(m-n)/(s-n),f=e,c=g,h=e+(m-n)/(l-n),S.push(p*x+A),S.push(f*N+T),S.push(c*x+A),S.push(h*N+T)),o!==a&&o!==u&&(p=g+1,f=e+1-(m-r)/(s-r),c=g+1-(m-r)/(l-r),h=e+1,S.push(p*x+A),S.push(f*N+T),S.push(c*x+A),S.push(h*N+T)),a!==u&&(p=(g+1-(m-s)/(l-s))*x+A,f=(e+(m-s)/(l-s))*N+T,a!==i&&(c=g+1-(m-s)/(n-s),h=e,S.push(p),S.push(f),S.push(c*x+A),S.push(h*N+T)),u!==i&&(c=g,h=e+1-(m-l)/(n-l),S.push(p),S.push(f),S.push(c*x+A),S.push(h*N+T)),a!==o&&(c=g+1,h=e+(m-s)/(r-s),S.push(p),S.push(f),S.push(c*x+A),S.push(h*N+T)),u!==o&&(c=g+(m-l)/(r-l),h=e+1,S.push(p),S.push(f),S.push(c*x+A),S.push(h*N+T)))}}return{minX:e.minX,maxX:e.maxX,minY:e.minY,maxY:e.maxY,segments:w}}(n,t),delete n.z),e.minMax=n}const A={"1H":267522187.44,"2H":41065e3,"3H":285350800,"3He":-203789e3,"7Li":103962e3,"13C":67282840,"14N":19331e3,"15N":-27116e3,"17O":-36264e3,"19F":251662e3,"23Na":70761e3,"27Al":69763e3,"29Si":-5319e4,"31P":108291e3,"57Fe":8681e3,"63Cu":71118e3,"67Zn":16767e3,"129Xe":-73997e3};function x(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n.logger?.trace(t),e.profiling&&e.profiling.push({action:t,time:Date.now()-n.start})}function T(e){let t=e.spectra[0].data;e.chromatogram={times:t.x.slice(),series:{intensity:{dimension:1,data:t.y.slice()}}}}function N(e,t,n){!function(e){for(let t of e){let e=0,n=0;for(let s of t.spectra){if(t.ntuples&&t.ntuples.symbol?(!e&&s.observeFrequency&&(e=s.observeFrequency),!n&&s.shiftOffsetVal&&(n=s.shiftOffsetVal)):(e=s.observeFrequency,n=s.shiftOffsetVal),e&&s.xUnits&&s.xUnits.toUpperCase().includes("HZ")){s.xUnits="PPM",s.xFactor=s.xFactor/e,s.firstX=s.firstX/e,s.lastX=s.lastX/e,s.deltaX=s.deltaX/e;for(let t=0;t<s.data.x.length;t++)s.data.x[t]/=e}if(n&&s.xUnits.toLowerCase().includes("ppm")){let e=s.firstX-n;s.firstX=s.firstX-e,s.lastX=s.lastX-e;for(let t=0;t<s.data.x.length;t++)s.data.x[t]-=e}if(t.ntuples&&t.ntuples.nucleus&&t.ntuples.symbol)for(let e=0;e<t.ntuples.nucleus.length;e++){let n=t.ntuples.symbol[e],s=t.ntuples.nucleus[e];if(n.match(/^[F|T]/)&&!s){if(n.match(/[F|T]1/))if(t.tmp.$NUC2)t.ntuples.nucleus[e]=t.tmp.$NUC2;else{let s=t.ntuples.symbol.indexOf(n.replace(/^([F|T]).*/,"$12"));s&&t.ntuples.nucleus[s]&&(t.ntuples.nucleus[e]=t.ntuples.nucleus[s])}n.match(/[F|T]2/)&&(t.ntuples.nucleus[e]=t.tmp.$NUC1)}n.match(/[F|T]2/)&&(t.yType=t.ntuples.nucleus[0])}if(e&&t.ntuples&&t.ntuples.symbol&&t.ntuples.nucleus){let n="",l=t.ntuples.symbol.indexOf(s.pageSymbol);if(t.ntuples.units&&t.ntuples.units[l]&&(n=t.ntuples.units[l]),"PPM"!==n){if(0!==l)throw Error("Not sure about this ntuples format");let n=A[t.ntuples.nucleus[0]],r=A[t.ntuples.nucleus[1]];if(!n||!r)throw Error("Problem with determination of gyromagnetic ratio");let i=n/r*e;s.pageValue/=i}}}}}(e);for(let s of e){if(Object.keys(s.ntuples).length>0){let e=[],t=Object.keys(s.ntuples);for(let n=0;n<t.length;n++){let l=t[n],r=s.ntuples[l];for(let t=0;t<r.length;t++)e[t]||(e[t]={}),e[t][l]=r[t]}s.ntuples=e}s.twoD&&n.wantXY&&(y(s,n),x(t,"Finished countour plot calculation",n),n.keepSpectra||delete s.spectra),n.chromatogram&&(s.spectra.length>1?r(s):T(s),x(t,"Finished chromatogram calculation",n)),delete s.tmp}}function X(e,t,n){let s=-1,l=-1,r="",i="";if(n.indexOf("++")>0)r=n.replace(/.*\(([a-zA-Z0-9]+)\+\+.*/,"$1"),i=n.replace(/.*\.\.([a-zA-Z0-9]+).*/,"$1");else{r=(n=n.replace(/[^a-zA-Z]/g,"")).charAt(0),i=n.charAt(1),t.variables={};for(let s of n){let n=s.toLowerCase(),l=e.ntuples.symbol.indexOf(s);if(-1===l)throw Error(`Symbol undefined: ${s}`);t.variables[n]={};for(let s in e.ntuples)e.ntuples[s][l]&&(t.variables[n][s.replace(/^var/,"")]=e.ntuples[s][l])}}s=e.ntuples.symbol.indexOf(r),l=e.ntuples.symbol.indexOf(i),-1===s&&(s=0),-1===l&&(l=0),e.ntuples.first&&(e.ntuples.first.length>s&&(t.firstX=e.ntuples.first[s]),e.ntuples.first.length>l&&(t.firstY=e.ntuples.first[l])),e.ntuples.last&&(e.ntuples.last.length>s&&(t.lastX=e.ntuples.last[s]),e.ntuples.last.length>l&&(t.lastY=e.ntuples.last[l])),e.ntuples.vardim&&e.ntuples.vardim.length>s&&(t.nbPoints=e.ntuples.vardim[s]),e.ntuples.factor&&(e.ntuples.factor.length>s&&(t.xFactor=e.ntuples.factor[s]),e.ntuples.factor.length>l&&(t.yFactor=e.ntuples.factor[l])),e.ntuples.units&&(e.ntuples.units.length>s&&(e.ntuples.varname&&e.ntuples.varname[s]?t.xUnits=`${e.ntuples.varname[s]} [${e.ntuples.units[s]}]`:t.xUnits=e.ntuples.units[s]),e.ntuples.units.length>l&&(e.ntuples.varname&&e.ntuples.varname[l]?t.yUnits=`${e.ntuples.varname[l]} [${e.ntuples.units[l]}]`:t.yUnits=e.ntuples.units[l]))}function v(e){e.xFactor||(e.xFactor=1),e.yFactor||(e.yFactor=1)}const E=/[ \t]*,[ \t]*/,w={keepRecordsRegExp:/^$/,canonicDataLabels:!0,canonicMetadataLabels:!1,dynamicTyping:!0,withoutXY:!1,chromatogram:!1,keepSpectra:!1,noContour:!1,nbContourLevels:7,noiseMultiplier:5,profiling:!1};e.convert=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e=t(e),n={...w,...n},n.logger?.debug("Starting jcamp conversion"),n.wantXY=!n.withoutXY,n.start=Date.now();let l=[],r={profiling:!!n.profiling&&[],logs:[],entries:[]},p={children:[]},f=p,m=[],d={};if("string"!=typeof e)throw new TypeError("the JCAMP should be a string");x(r,"Before split to LDRS",n);let g=e.replace(/[\r\n]+##/g,"\n##").split("\n##");x(r,"Split to LDRS",n),g[0]&&(g[0]=g[0].replace(/^[\r\n ]*##/,""));for(let e of g){let t=e.indexOf("="),p=t>0?e.substring(0,t):e,g=t>0?e.substring(t+1).trim():"",b=p.replace(/[_ -]/g,"").toUpperCase();if("DATATABLE"===b){let e=g.indexOf("\n");if(-1===e&&(e=g.indexOf("\r")),e>0){let t=g.substring(0,e).split(/[ ,;\t]+/);X(f,d,t[0]),d.datatable=t[0],t[1]&&t[1].indexOf("PEAKS")>-1?b="PEAKTABLE":t[1]&&(t[1].indexOf("XYDATA")||t[0].indexOf("++")>0)&&(b="XYDATA",d.nbPoints&&(d.deltaX=(d.lastX-d.firstX)/(d.nbPoints-1)))}}if("XYDATA"!==b)if("PEAKTABLE"!==b)if("PEAKASSIGNMENTS"!==b){if("TITLE"===b){let e=f;e.children||(e.children=[]),f={spectra:[],ntuples:{},info:{},meta:{},tmp:{}},e.children.push(f),m.push(e),l.push(f),f.title=g}else"DATATYPE"===b?(f.dataType=g,g.match(/(^nd|\snd\s)/i)&&(f.twoD=!0)):"NTUPLES"===b?g.match(/(^nd|\snd\s)/i)&&(f.twoD=!0):"DATACLASS"===b?f.dataClass=g:"XUNITS"===b?d.xUnits=g:"YUNITS"===b?d.yUnits=g:"FIRSTX"===b?d.firstX=Number(g):"LASTX"===b?d.lastX=Number(g):"FIRSTY"===b?d.firstY=Number(g):"LASTY"===b?d.lastY=Number(g):"NPOINTS"===b?d.nbPoints=Number(g):"XFACTOR"===b?d.xFactor=Number(g):"YFACTOR"===b?d.yFactor=Number(g):"MAXX"===b?d.maxX=Number(g):"MINX"===b?d.minX=Number(g):"MAXY"===b?d.maxY=Number(g):"MINY"===b?d.minY=Number(g):"DELTAX"===b?d.deltaX=Number(g):".OBSERVEFREQUENCY"===b||"$SFO1"===b?d.observeFrequency||(d.observeFrequency=Number(g)):".OBSERVENUCLEUS"===b?d.xType||(f.xType=g.replace(/[^a-zA-Z0-9]/g,"")):"$OFFSET"===b?(f.shiftOffsetNum=0,d.shiftOffsetVal||(d.shiftOffsetVal=Number(g))):"$REFERENCEPOINT"===b||("VARNAME"===b?f.ntuples.varname=g.split(E):"SYMBOL"===b?f.ntuples.symbol=g.split(E):"VARTYPE"===b?f.ntuples.vartype=g.split(E):"VARFORM"===b?f.ntuples.varform=g.split(E):"VARDIM"===b?f.ntuples.vardim=u(g.split(E)):"UNITS"===b?f.ntuples.units=g.split(E):"FACTOR"===b?f.ntuples.factor=u(g.split(E)):"FIRST"===b?f.ntuples.first=u(g.split(E)):"LAST"===b?f.ntuples.last=u(g.split(E)):"MIN"===b?f.ntuples.min=u(g.split(E)):"MAX"===b?f.ntuples.max=u(g.split(E)):".NUCLEUS"===b?f.ntuples&&(f.ntuples.nucleus=g.split(E)):"PAGE"===b?(d.page=g.trim(),d.pageValue=Number(g.replace(/^.*=/,"")),d.pageSymbol=d.page.replace(/[=].*/,"")):"RETENTIONTIME"===b?d.pageValue=Number(g):i(b)?d[a(b)]=g:"SAMPLEDESCRIPTION"===b?d.sampleDescription=g:b.startsWith("$NUC")?f.tmp[b]||g.includes("off")||(f.tmp[b]=g.replace(/[<>]/g,"")):"END"===b&&(f=m.pop()));if(f&&f.info&&f.meta&&b.match(n.keepRecordsRegExp)){let e,t,l=g.trim();p.startsWith("$")?(t=n.canonicMetadataLabels?b.substring(1):p.substring(1),e=f.meta):(t=n.canonicDataLabels?b:p,e=f.info),n.dynamicTyping&&(l=s(l)),e[t]?(Array.isArray(e[t])||(e[t]=[e[t]]),e[t].push(l)):e[t]=l}}else n.wantXY&&(g.match(/.*([^A-Z]*).*/)&&h(d,g),f.spectra.push(d),d={});else n.wantXY&&(v(d),c(d,g,r),f.spectra.push(d),d={});else n.wantXY&&(v(d),g.match(/.*\+\+.*/)?(d.nbPoints&&(d.deltaX=(d.lastX-d.firstX)/(d.nbPoints-1)),o(d,g)):c(d,g,r),f.spectra.push(d),d={})}return x(r,"Finished parsing",n),N(l,r,n),x(r,"Total time",n),r.entries=p.children,r.flatten=l,r},e.createTree=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e=t(e);const{flatten:s=!1}=n;if("string"!=typeof e)throw new TypeError("the JCAMP should be a string");let l,r=e.split(/[\r\n]+/),i=[],a=[],u=[],o=0,p=e.includes("## ");for(let e=0;e<r.length;e++){let t=r[e],n=p?t.replace(/ /g,""):t;if("##NTUPLES"===n.substring(0,9)&&o++,"##TITLE"===n.substring(0,7)){let s=[n.substring(8).trim()];for(let t=e+1;t<r.length&&!r[t].startsWith("##");t++)s.push(r[t].trim());a.push({title:s.join("\n"),jcamp:`${t}\n`,children:[]}),l=a[a.length-1],i.push(l)}else if("##END"===n.substring(0,5)&&0===o){l.jcamp+=`${t}\n`;let e=a.pop();0!==a.length?(l=a[a.length-1],l.children.push(e)):(l=void 0,u.push(e))}else if(l&&l.jcamp){l.jcamp+=`${t}\n`;let e=n.match(/^##(.*?)=(.+)/);if(e){let t=e[1].replace(/[ _-]/g,"").toUpperCase();"DATATYPE"===t&&(l.dataType=e[2].trim()),"DATACLASS"===t&&(l.dataClass=e[2].trim())}}"##END"===n.substring(0,5)&&o>0&&o--}return s?(i.forEach((e=>{e.children=void 0})),i):u},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=jcampconverter.min.js.map
